# RGB image build scripts
# Copyright (C) 2024-2025  Shihan Zhao
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

Bootstrap: localimage
From: rgb_base.sif

%arguments
    MPICH_VERSION=4.3.2

%post
    apt -y install libfabric-dev libhwloc-dev libibverbs-dev rdma-core librdmacm-dev libpsm2-dev libpsm-infinipath1-dev
    apt clean

    cd /opt
    mkdir mpich-build
    cd mpich-build
    wget -c -t=999 https://www.mpich.org/static/downloads/{{MPICH_VERSION}}/mpich-{{MPICH_VERSION}}.tar.gz -O mpich.tar.gz
    tar -xf mpich.tar.gz

    for arch in 'x86-64-v3' 'x86-64-v2'; do
        mkdir build-$arch
        cd build-$arch
        ../mpich-{{MPICH_VERSION}}/configure \
            --prefix=/opt/$arch/mpich \
            --build=x86_64-unknown-linux-gnu \
            --disable-g \
            --enable-opt=O3,ndebug,alwaysinline \
            --enable-threads=multiple \
            --disable-dependency-tracking \
            --enable-shared \
            --disable-static \
            --disable-doc \
            --with-device=ch4:ofi \
            --with-pic \
            --with-libfabric=/usr \
            --with-hwloc=/usr \
            CC=gcc-opt \
            CXX=g++-opt \
            F77=gfortran-opt \
            FC=gfortran-opt \
            CFLAGS="-march=$arch" \
            CXXFLAGS="-march=$arch" \
            FFLAGS="-march=$arch" \
            FCFLAGS="-march=$arch" \
            MPICHLIB_CFLAGS="-O3 -flto=auto -fno-fat-lto-objects -DNDEBUG -DNVALGRIND" \
            MPICHLIB_CXXFLAGS="-O3 -flto=auto -fno-fat-lto-objects -DNDEBUG -DNVALGRIND" \
            MPICHLIB_FFLAGS="-O3 -flto=auto -fno-fat-lto-objects" \
            MPICHLIB_FCFLAGS="-O3 -flto=auto -fno-fat-lto-objects" &
        cd ..
    done
    wait

    for arch in 'x86-64-v3' 'x86-64-v2'; do
        cd build-$arch
        make -j$(echo "$(nproc --all) / $(env LC_ALL=C lscpu | grep "Thread(s) per core" | awk '{print $4}')" | bc) &
        cd ..
    done
    wait

    for arch in 'x86-64-v3' 'x86-64-v2'; do
        cd build-$arch
        make install
        cd ..
    done

    cd ..
    rm -rf mpich-build

%labels
    MPI mpich-{{MPICH_VERSION}}

%environment
    MPICH_DIR=/opt/$RUNTIME_X86_VERSION/mpich
    export PATH=$MPICH_DIR/bin:$PATH
    export LIBRARY_PATH=$MPICH_DIR/lib:$LIBRARY_PATH
    export LD_LIBRARY_PATH=$MPICH_DIR/lib:$LD_LIBRARY_PATH
    export MANPATH=$MPICH_DIR/share/man:$MANPATH
    export CMAKE_PREFIX_PATH=$MPICH_DIR:$CMAKE_PREFIX_PATH

    export MPICH_CC=gcc-opt
    export MPICH_CXX=g++-opt
    export MPICH_FC=gfortran-opt
