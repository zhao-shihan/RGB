# RGB image build scripts
# Copyright (C) 2024-2025  Shihan Zhao
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

Bootstrap: localimage
From: {{BASE}}

%arguments
    BASE=

%post
    cd /opt

    cd root-build
    for arch in 'x86-64-v4' 'x86-64-v3'; do
        mkdir build-$arch
        cd build-$arch
        cmake -G Ninja ../src/ \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_STANDARD=17 \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
            -Dfftw3=ON \
            -Dgviz=ON \
            -Dmathmore=ON \
            -Dmpi=ON \
            -Dqt6web=ON \
            -Dshadowpw=ON \
            -Dsoversion=ON \
            -Dunfold=ON \
            -Dunuran=ON \
            -During=ON \
            -Duse_gsl_cblas=OFF \
            -Dtmva-cudnn=OFF \
            -DCMAKE_INSTALL_PREFIX=/opt/$arch/root \
            -DCMAKE_C_FLAGS="-march=$arch" \
            -DCMAKE_CXX_FLAGS="-march=$arch"
        ninja
        ninja install
        cd ..
    done
    cd ..
    rm -rf root-build

    cd geant4-build
    for arch in 'x86-64-v4' 'x86-64-v3'; do
        mkdir build-$arch
        cd build-$arch
        cmake -G Ninja ../src/ \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_C_STANDARD=17 \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
            -DGEANT4_INSTALL_DATADIR=/opt/geant4-data \
            -DGEANT4_USE_GDML=ON \
            -DGEANT4_USE_OPENGL_X11=ON \
            -DGEANT4_USE_QT=ON \
            -DGEANT4_USE_RAYTRACER_X11=ON \
            -DGEANT4_USE_SYSTEM_ZLIB=ON \
            -DGEANT4_INSTALL_DATASETS_TENDL=ON \
            -DGEANT4_INSTALL_DATASETS_NUDEXLIB=ON \
            -DGEANT4_INSTALL_DATASETS_URRPT=ON \
            -DCMAKE_INSTALL_PREFIX=/opt/$arch/geant4 \
            -DCMAKE_C_FLAGS="-march=$arch" \
            -DCMAKE_CXX_FLAGS="-march=$arch"
        ninja
        ninja install
        cd ..
    done
    cd ..
    rm -rf geant4-build

    update_root_env() {
        ROOT_DIR=/opt/$1/root
        export PATH=$ROOT_DIR/bin:$PATH
        export LIBRARY_PATH=$ROOT_DIR/lib:$LIBRARY_PATH
        export LD_LIBRARY_PATH=$ROOT_DIR/lib:$LD_LIBRARY_PATH
        export PYTHONPATH=$ROOT_DIR/lib:$PYTHONPATH
        export MANPATH=$ROOT_DIR/man:$MANPATH
        export CMAKE_PREFIX_PATH=$ROOT_DIR:$CMAKE_PREFIX_PATH
        export JUPYTER_PATH=$ROOT_DIR/etc/notebook:$JUPYTER_PATH
        export JUPYTER_CONFIG_DIR=$ROOT_DIR/etc/notebook:$JUPYTER_CONFIG_DIR
        export ROOTSYS=$ROOT_DIR
        export CLING_STANDARD_PCH=none
    }

    cd garfieldpp-build
    for arch in 'x86-64-v4' 'x86-64-v3'; do
        update_root_env $arch
        mkdir build-$arch
        cd build-$arch
        cmake ../src/ \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++ \
            -DCMAKE_Fortran_COMPILER=gfortran \
            -DCMAKE_C_STANDARD=17 \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_INSTALL_PREFIX=/opt/$arch/garfieldpp \
            -DCMAKE_C_FLAGS="-march=$arch" \
            -DCMAKE_CXX_FLAGS="-march=$arch" \
            -DCMAKE_Fortran_FLAGS="-march=$arch"
        make -j$(grep "processor" /proc/cpuinfo | sort | uniq | wc -l)
        make install
        cd ..
    done
    cd ..
    rm -rf garfieldpp-build

%environment
    GEANT4_DIR=/opt/$HOST_AMD64_ABI_VERSION/geant4
    export PATH=$GEANT4_DIR/bin:$PATH
    export LIBRARY_PATH=$GEANT4_DIR/lib:$LIBRARY_PATH
    export LD_LIBRARY_PATH=$GEANT4_DIR/lib:$LD_LIBRARY_PATH
    export CMAKE_PREFIX_PATH=$GEANT4_DIR:$CMAKE_PREFIX_PATH

    ROOT_DIR=/opt/$HOST_AMD64_ABI_VERSION/root
    export PATH=$ROOT_DIR/bin:$PATH
    export LIBRARY_PATH=$ROOT_DIR/lib:$LIBRARY_PATH
    export LD_LIBRARY_PATH=$ROOT_DIR/lib:$LD_LIBRARY_PATH
    export PYTHONPATH=$ROOT_DIR/lib:$PYTHONPATH
    export MANPATH=$ROOT_DIR/man:$MANPATH
    export CMAKE_PREFIX_PATH=$ROOT_DIR:$CMAKE_PREFIX_PATH
    export JUPYTER_PATH=$ROOT_DIR/etc/notebook:$JUPYTER_PATH
    export JUPYTER_CONFIG_DIR=$ROOT_DIR/etc/notebook:$JUPYTER_CONFIG_DIR
    export ROOTSYS=$ROOT_DIR
    export CLING_STANDARD_PCH=none

    export GARFIELDPP_INSTALL=/opt/$HOST_AMD64_ABI_VERSION/garfieldpp
    export LIBRARY_PATH=$GARFIELDPP_INSTALL/lib:$LIBRARY_PATH
    export LD_LIBRARY_PATH=$GARFIELDPP_INSTALL/lib:$LD_LIBRARY_PATH
    export CMAKE_PREFIX_PATH=$GARFIELDPP_INSTALL:$CMAKE_PREFIX_PATH
    export HEED_DATABASE=$GARFIELDPP_INSTALL/share/Heed/database
    export PYTHONPATH=$(find $GARFIELDPP_INSTALL/lib -name site-packages | sed -n 1p):$PYTHONPATH
