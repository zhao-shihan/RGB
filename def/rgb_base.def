# RGB image build scripts
# Copyright (C) 2024-2025  Shihan Zhao
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

Bootstrap: docker
From: debian:{{DEBIAN_VERSION}}

%arguments
    DEBIAN_VERSION=stable-slim
    ROOT_VERSION=6.36.04
    GEANT4_VERSION=11.3.2
    GARFIELDPP_VERSION=5.0
    G4NDL_VERSION=4.7.1
    G4EMLOW_VERSION=8.6.1
    G4PhotonEvaporation_VERSION=6.1
    G4RadioactiveDecay_VERSION=6.1.2
    G4PARTICLEXS_VERSION=4.1
    G4PII_VERSION=1.3
    G4RealSurface_VERSION=2.2
    G4SAIDDATA_VERSION=2.0
    G4ABLA_VERSION=3.3
    G4INCL_VERSION=1.2
    G4ENSDFSTATE_VERSION=3.0
    G4CHANNELING_VERSION=1.0
    G4TENDL_VERSION=1.4
    G4NUDEXLIB_VERSION=1.0
    G4URRPT_VERSION=1.1
    PACKAGE_HOST_DIR=
    DATA_HOST_DIR=

%files
    # Sources
    {{PACKAGE_HOST_DIR}}/root_v{{ROOT_VERSION}}.source.tar.gz /opt
    {{PACKAGE_HOST_DIR}}/geant4-v{{GEANT4_VERSION}}.tar.gz /opt
    {{PACKAGE_HOST_DIR}}/garfieldpp-{{GARFIELDPP_VERSION}}.tar.gz /opt
    # Geant4 data
    {{DATA_HOST_DIR}}/g4data/G4NDL.{{G4NDL_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4EMLOW.{{G4EMLOW_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4PhotonEvaporation.{{G4PhotonEvaporation_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4RadioactiveDecay.{{G4RadioactiveDecay_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4PARTICLEXS.{{G4PARTICLEXS_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4PII.{{G4PII_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4RealSurface.{{G4RealSurface_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4SAIDDATA.{{G4SAIDDATA_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4ABLA.{{G4ABLA_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4INCL.{{G4INCL_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4ENSDFSTATE.{{G4ENSDFSTATE_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4CHANNELING.{{G4CHANNELING_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4TENDL.{{G4TENDL_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4NUDEXLIB.{{G4NUDEXLIB_VERSION}}.tar.gz /opt
    {{DATA_HOST_DIR}}/g4data/G4URRPT.{{G4URRPT_VERSION}}.tar.gz /opt

%post
    sed -i 's/deb\.debian\.org/ftp.cn.debian.org/g' /etc/apt/sources.list.d/debian.sources

    apt -y update
    apt -y install apt-utils
    apt -y full-upgrade
    apt -y autopurge
    apt -y install \
        build-essential \
        gfortran \
        clang \
        gdb \
        wget \
        curl \
        vim \
        nano \
        unzip \
        bc \
        git \
        cmake \
        ninja-build \
        python3-dev \
        python3 \
        python3-numpy \
        python3-venv \
        python3-pip \
        libx11-dev \
        libxpm-dev \
        libxft-dev \
        libxext-dev \
        libpng-dev \
        libjpeg-dev \
        libssl-dev \
        uuid-dev \
        libpcre2-dev \
        libsqlite3-dev \
        libfftw3-dev \
        libcfitsio-dev \
        libavahi-compat-libdnssd-dev \
        libldap-dev \
        libxml2-dev \
        libkrb5-dev \
        libtbb-dev \
        libopenblas-dev \
        libgsl-dev \
        libunuran-dev \
        liburing-dev \
        libgraphviz-dev \
        libgif-dev \
        davix-dev \
        libglu1-mesa-dev \
        libglew-dev \
        libftgl-dev \
        libafterimage-dev \
        qt3d5-dev \
        qt6-3d-dev \
        libxmu-dev \
        qt6-webengine-dev \
        libgl2ps-dev \
        liblz4-dev \
        liblzma-dev \
        nlohmann-json3-dev \
        libvdt-dev \
        xrootd-client \
        xrootd-server \
        libxrootd-client-dev \
        libxrootd-server-dev \
        libxxhash-dev \
        libxerces-c-dev \
        libexpat1-dev \
        libglib2.0-dev \
        gnulib \
        libzstd-dev \
        binutils-dev \
        libdw-dev \
        libdwarf-dev \
        libunwind-dev \
        libeigen3-dev \
        libfmt-dev \
        libbackward-cpp-dev \
        libmsgsl-dev \
        libyaml-cpp-dev \
        python-is-python3 \
        python-dev-is-python3 \
        libmimalloc3

    gcc_opt_path=/usr/local/bin/gcc-opt
    echo '#!/bin/bash' >$gcc_opt_path
    echo $(which gcc)' -O3 -march=$RUNTIME_X86_VERSION $@' >>$gcc_opt_path
    chmod +x $gcc_opt_path
    update-alternatives --install /usr/bin/cc cc $gcc_opt_path 100

    gxx_opt_path=/usr/local/bin/g++-opt
    echo '#!/bin/bash' >$gxx_opt_path
    echo $(which g++)' -O3 -march=$RUNTIME_X86_VERSION $@' >>$gxx_opt_path
    chmod +x $gxx_opt_path
    update-alternatives --install /usr/bin/c++ c++ $gxx_opt_path 100

    gfortran_opt_path=/usr/local/bin/gfortran-opt
    echo '#!/bin/bash' >$gfortran_opt_path
    echo $(which gfortran)' -O3 -march=$RUNTIME_X86_VERSION $@' >>$gfortran_opt_path
    chmod +x $gfortran_opt_path
    update-alternatives --install /usr/bin/f77 f77 $gfortran_opt_path 100
    update-alternatives --install /usr/bin/f95 f95 $gfortran_opt_path 100

    clang_opt_path=/usr/local/bin/clang-opt
    echo '#!/bin/bash' >$clang_opt_path
    echo $(which clang)' -O3 -march=$RUNTIME_X86_VERSION $@' >>$clang_opt_path
    chmod +x $clang_opt_path

    clangxx_opt_path=/usr/local/bin/clang++-opt
    echo '#!/bin/bash' >$clangxx_opt_path
    echo $(which clang++)' -O3 -march=$RUNTIME_X86_VERSION $@' >>$clangxx_opt_path
    chmod +x $clangxx_opt_path

    cd /opt

    mkdir root-build
    mv root_v{{ROOT_VERSION}}.source.tar.gz root-build/root.tar.gz
    cd root-build
    tar -xf root.tar.gz
    mv root-{{ROOT_VERSION}} src
    rm root.tar.gz
    cd ..

    mkdir geant4-build
    mv geant4-v{{GEANT4_VERSION}}.tar.gz geant4-build/geant4.tar.gz
    cd geant4-build
    tar -xf geant4.tar.gz
    mv geant4-v{{GEANT4_VERSION}} src
    rm geant4.tar.gz
    cd ..

    mkdir garfieldpp-build
    mv garfieldpp-{{GARFIELDPP_VERSION}}.tar.gz garfieldpp-build/garfieldpp.tar.gz
    cd garfieldpp-build
    tar -xf garfieldpp.tar.gz
    mv garfieldpp-{{GARFIELDPP_VERSION}} src
    rm garfieldpp.tar.gz
    cd ..

    mkdir geant4-data

    mv G4NDL.{{G4NDL_VERSION}}.tar.gz geant4-data/G4NDL.tar.gz
    mv G4EMLOW.{{G4EMLOW_VERSION}}.tar.gz geant4-data/G4EMLOW.tar.gz
    mv G4PhotonEvaporation.{{G4PhotonEvaporation_VERSION}}.tar.gz geant4-data/G4PhotonEvaporation.tar.gz
    mv G4RadioactiveDecay.{{G4RadioactiveDecay_VERSION}}.tar.gz geant4-data/G4RadioactiveDecay.tar.gz
    mv G4PARTICLEXS.{{G4PARTICLEXS_VERSION}}.tar.gz geant4-data/G4PARTICLEXS.tar.gz
    mv G4PII.{{G4PII_VERSION}}.tar.gz geant4-data/G4PII.tar.gz
    mv G4RealSurface.{{G4RealSurface_VERSION}}.tar.gz geant4-data/G4RealSurface.tar.gz
    mv G4SAIDDATA.{{G4SAIDDATA_VERSION}}.tar.gz geant4-data/G4SAIDDATA.tar.gz
    mv G4ABLA.{{G4ABLA_VERSION}}.tar.gz geant4-data/G4ABLA.tar.gz
    mv G4INCL.{{G4INCL_VERSION}}.tar.gz geant4-data/G4INCL.tar.gz
    mv G4ENSDFSTATE.{{G4ENSDFSTATE_VERSION}}.tar.gz geant4-data/G4ENSDFSTATE.tar.gz
    mv G4CHANNELING.{{G4CHANNELING_VERSION}}.tar.gz geant4-data/G4CHANNELING.tar.gz
    mv G4TENDL.{{G4TENDL_VERSION}}.tar.gz geant4-data/G4TENDL.tar.gz
    mv G4NUDEXLIB.{{G4NUDEXLIB_VERSION}}.tar.gz geant4-data/G4NUDEXLIB.tar.gz
    mv G4URRPT.{{G4URRPT_VERSION}}.tar.gz geant4-data/G4URRPT.tar.gz

    cd geant4-data
    tar -xf G4NDL.tar.gz
    rm G4NDL.tar.gz
    tar -xf G4EMLOW.tar.gz
    rm G4EMLOW.tar.gz
    tar -xf G4PhotonEvaporation.tar.gz
    rm G4PhotonEvaporation.tar.gz
    tar -xf G4RadioactiveDecay.tar.gz
    rm G4RadioactiveDecay.tar.gz
    tar -xf G4PARTICLEXS.tar.gz
    rm G4PARTICLEXS.tar.gz
    tar -xf G4PII.tar.gz
    rm G4PII.tar.gz
    tar -xf G4RealSurface.tar.gz
    rm G4RealSurface.tar.gz
    tar -xf G4SAIDDATA.tar.gz
    rm G4SAIDDATA.tar.gz
    tar -xf G4ABLA.tar.gz
    rm G4ABLA.tar.gz
    tar -xf G4INCL.tar.gz
    rm G4INCL.tar.gz
    tar -xf G4ENSDFSTATE.tar.gz
    rm G4ENSDFSTATE.tar.gz
    tar -xf G4CHANNELING.tar.gz
    rm G4CHANNELING.tar.gz
    tar -xf G4TENDL.tar.gz
    rm G4TENDL.tar.gz
    tar -xf G4NUDEXLIB.tar.gz
    rm G4NUDEXLIB.tar.gz
    tar -xf G4URRPT.tar.gz
    rm G4URRPT.tar.gz
    cd ..

%labels
    Author zhaoshihan
    Debian {{DEBIAN_VERSION}}
    ROOT {{ROOT_VERSION}}
    Geant4 {{GEANT4_VERSION}}
    G4NDL {{G4NDL_VERSION}}
    G4EMLOW {{G4EMLOW_VERSION}}
    G4PhotonEvaporation {{G4PhotonEvaporation_VERSION}}
    G4RadioactiveDecay {{G4RadioactiveDecay_VERSION}}
    G4PARTICLEXS {{G4PARTICLEXS_VERSION}}
    G4PII {{G4PII_VERSION}}
    G4RealSurface {{G4RealSurface_VERSION}}
    G4SAIDDATA {{G4SAIDDATA_VERSION}}
    G4ABLA {{G4ABLA_VERSION}}
    G4INCL {{G4INCL_VERSION}}
    G4ENSDFSTATE {{G4ENSDFSTATE_VERSION}}
    G4TENDL {{G4TENDL_VERSION}}
    Garfield++ {{GARFIELDPP_VERSION}}

%environment
    export LC_ALL=C.utf8

    cpu_has_feature() {
        if test -n "$(grep flags /proc/cpuinfo | grep $1)"; then
            # 0 = true
            return 0
        else
            # 1 = false
            return 1
        fi
    }
    if cpu_has_feature avx && cpu_has_feature avx2 && cpu_has_feature bmi && cpu_has_feature bmi2 && cpu_has_feature f16c && cpu_has_feature fma && cpu_has_feature movbe && cpu_has_feature xsave; then
        export RUNTIME_X86_VERSION=x86-64-v3
    elif cpu_has_feature cx16 && cpu_has_feature lahf && cpu_has_feature popcnt && cpu_has_feature sse3 && cpu_has_feature sse4.1 && cpu_has_feature sse4.2 && cpu_has_feature ssse3; then
        export RUNTIME_X86_VERSION=x86-64-v2
    else
        echo "Warning: this machine is ancient!"
    fi

    export LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libmimalloc.so.3:$LD_PRELOAD

    if test -d /opt/geant4-data; then
        export GEANT4_DATA_DIR=/opt/geant4-data
    fi
